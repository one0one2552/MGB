<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Einstellungen - MGB - Mushroom Grow Box</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .settings-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .settings-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .settings-section h2 {
            color: var(--primary-color);
            margin-top: 0;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #a0aec0;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 5px;
            color: #fff;
            font-size: 16px;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .message {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        .message.success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }
        
        .message.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            color: #f44336;
        }
        
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        .info-text {
            color: #718096;
            font-size: 14px;
            margin-top: 5px;
        }
        
        /* PID Status Anzeige */
        .pid-status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .pid-status-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 8px;
            padding: 15px;
        }
        
        .pid-status-card h4 {
            color: var(--primary-color);
            margin: 0 0 10px 0;
            font-size: 1rem;
        }
        
        .pid-param {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .pid-param:last-child {
            border-bottom: none;
        }
        
        .pid-param-label {
            color: #a0aec0;
            font-size: 0.9rem;
        }
        
        .pid-param-value {
            color: #fff;
            font-weight: bold;
        }
        
        .pid-param-change {
            font-size: 0.8rem;
            margin-left: 5px;
        }
        
        .pid-param-change.positive {
            color: #4caf50;
        }
        
        .pid-param-change.negative {
            color: #f39c12;
        }
        
        /* Terminal */
        .terminal-container {
            background: #1a1a1a;
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
        }
        
        .terminal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(76, 175, 80, 0.3);
        }
        
        .terminal-title {
            color: var(--primary-color);
            font-weight: bold;
        }
        
        .terminal-buttons {
            display: flex;
            gap: 5px;
        }
        
        .terminal-btn {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .terminal-btn.close { background: #ff5f56; }
        .terminal-btn.minimize { background: #ffbd2e; }
        .terminal-btn.maximize { background: #27c93f; }
        
        .terminal-output {
            background: #000;
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .terminal-output::-webkit-scrollbar {
            width: 8px;
        }
        
        .terminal-output::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        .terminal-output::-webkit-scrollbar-thumb {
            background: rgba(76, 175, 80, 0.5);
            border-radius: 4px;
        }
        
        .terminal-line {
            margin: 2px 0;
        }
        
        .terminal-line.info { color: #00ff00; }
        .terminal-line.warning { color: #ffbd2e; }
        .terminal-line.error { color: #ff5f56; }
        .terminal-line.success { color: #27c93f; }
        
        .terminal-prompt {
            color: var(--primary-color);
        }
        
        .terminal-input-container {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        
        .terminal-input {
            flex: 1;
            background: #000;
            border: 1px solid rgba(76, 175, 80, 0.3);
            color: #00ff00;
            padding: 8px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        
        .terminal-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="settings-container">
            <a href="/" class="back-link">‚Üê Zur√ºck zum Dashboard</a>
            
            <h1>‚öôÔ∏è Einstellungen</h1>
            
            <div id="message" class="message"></div>
            
            <form id="settingsForm">
                <!-- Temperatur Einstellungen -->
                <div class="settings-section">
                    <h2>üå°Ô∏è Temperatur</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="temp_target">Zielwert (¬∞C)</label>
                            <input type="number" id="temp_target" name="temp_target" step="0.5" min="10" max="35" required>
                            <p class="info-text">Empfohlen: 20-24¬∞C</p>
                        </div>
                        <div class="form-group">
                            <label for="temp_tolerance">Toleranz (¬±¬∞C)</label>
                            <input type="number" id="temp_tolerance" name="temp_tolerance" step="0.1" min="0.1" max="5" required>
                            <p class="info-text">Abweichung vom Zielwert</p>
                        </div>
                    </div>
                </div>
                
                <!-- Luftfeuchtigkeit Einstellungen -->
                <div class="settings-section">
                    <h2>üíß Luftfeuchtigkeit</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="humidity_target">Zielwert (%)</label>
                            <input type="number" id="humidity_target" name="humidity_target" step="1" min="50" max="95" required>
                            <p class="info-text">Empfohlen: 80-90%</p>
                        </div>
                        <div class="form-group">
                            <label for="humidity_tolerance">Toleranz (¬±%)</label>
                            <input type="number" id="humidity_tolerance" name="humidity_tolerance" step="1" min="1" max="10" required>
                            <p class="info-text">Abweichung vom Zielwert</p>
                        </div>
                    </div>
                </div>
                
                <!-- CO2 Einstellungen -->
                <div class="settings-section">
                    <h2>üå¨Ô∏è CO‚ÇÇ-Gehalt</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="co2_target">Zielwert (ppm)</label>
                            <input type="number" id="co2_target" name="co2_target" step="50" min="400" max="2000" required>
                            <p class="info-text">Empfohlen: 600-1000 ppm</p>
                        </div>
                        <div class="form-group">
                            <label for="co2_tolerance">Toleranz (¬±ppm)</label>
                            <input type="number" id="co2_tolerance" name="co2_tolerance" step="10" min="10" max="200" required>
                            <p class="info-text">Abweichung vom Zielwert</p>
                        </div>
                    </div>
                </div>
                
                <!-- Tag/Nacht Zeitplan -->
                <div class="settings-section">
                    <h2>üåì Tag/Nacht-Rhythmus</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="day_start">Tag beginnt um</label>
                            <input type="time" id="day_start" name="day_start" required>
                        </div>
                        <div class="form-group">
                            <label for="night_start">Nacht beginnt um</label>
                            <input type="time" id="night_start" name="night_start" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="day_temperature">Tagtemperatur (¬∞C)</label>
                            <input type="number" id="day_temperature" name="day_temperature" step="0.5" min="10" max="35" required>
                        </div>
                        <div class="form-group">
                            <label for="night_temperature">Nachttemperatur (¬∞C)</label>
                            <input type="number" id="night_temperature" name="night_temperature" step="0.5" min="10" max="35" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="day_humidity">Tagfeuchtigkeit (%)</label>
                            <input type="number" id="day_humidity" name="day_humidity" step="1" min="50" max="95" required>
                        </div>
                        <div class="form-group">
                            <label for="night_humidity">Nachtfeuchtigkeit (%)</label>
                            <input type="number" id="night_humidity" name="night_humidity" step="1" min="50" max="95" required>
                        </div>
                    </div>
                </div>
                
                <!-- PID-Regelung Einstellungen -->
                <div class="settings-section">
                    <h2>üéõÔ∏è PID-Regelung</h2>
                    
                    <!-- Live PID Status -->
                    <div style="background: rgba(76, 175, 80, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: var(--primary-color); margin: 0 0 15px 0; font-size: 1rem;">
                            üìä Aktuelle PID-Werte (Live)
                        </h3>
                        <div class="pid-status-grid">
                            <!-- Temperatur PID Status -->
                            <div class="pid-status-card">
                                <h4>üå°Ô∏è Temperatur</h4>
                                <div class="pid-param">
                                    <span class="pid-param-label">Kp:</span>
                                    <span>
                                        <span id="temp-kp-current" class="pid-param-value">-</span>
                                        <span id="temp-kp-change" class="pid-param-change"></span>
                                    </span>
                                </div>
                                <div class="pid-param">
                                    <span class="pid-param-label">Ki:</span>
                                    <span>
                                        <span id="temp-ki-current" class="pid-param-value">-</span>
                                        <span id="temp-ki-change" class="pid-param-change"></span>
                                    </span>
                                </div>
                                <div class="pid-param">
                                    <span class="pid-param-label">Kd:</span>
                                    <span>
                                        <span id="temp-kd-current" class="pid-param-value">-</span>
                                        <span id="temp-kd-change" class="pid-param-change"></span>
                                    </span>
                                </div>
                                <div class="pid-param">
                                    <span class="pid-param-label">√ò Fehler:</span>
                                    <span id="temp-avg-error" class="pid-param-value">-</span>
                                </div>
                            </div>
                            
                            <!-- Luftfeuchtigkeit PID Status -->
                            <div class="pid-status-card">
                                <h4>üíß Luftfeuchtigkeit</h4>
                                <div class="pid-param">
                                    <span class="pid-param-label">Kp:</span>
                                    <span>
                                        <span id="humidity-kp-current" class="pid-param-value">-</span>
                                        <span id="humidity-kp-change" class="pid-param-change"></span>
                                    </span>
                                </div>
                                <div class="pid-param">
                                    <span class="pid-param-label">Ki:</span>
                                    <span>
                                        <span id="humidity-ki-current" class="pid-param-value">-</span>
                                        <span id="humidity-ki-change" class="pid-param-change"></span>
                                    </span>
                                </div>
                                <div class="pid-param">
                                    <span class="pid-param-label">Kd:</span>
                                    <span>
                                        <span id="humidity-kd-current" class="pid-param-value">-</span>
                                        <span id="humidity-kd-change" class="pid-param-change"></span>
                                    </span>
                                </div>
                                <div class="pid-param">
                                    <span class="pid-param-label">√ò Fehler:</span>
                                    <span id="humidity-avg-error" class="pid-param-value">-</span>
                                </div>
                            </div>
                            
                            <!-- CO2 PID Status -->
                            <div class="pid-status-card">
                                <h4>üå¨Ô∏è CO‚ÇÇ</h4>
                                <div class="pid-param">
                                    <span class="pid-param-label">Kp:</span>
                                    <span>
                                        <span id="co2-kp-current" class="pid-param-value">-</span>
                                        <span id="co2-kp-change" class="pid-param-change"></span>
                                    </span>
                                </div>
                                <div class="pid-param">
                                    <span class="pid-param-label">Ki:</span>
                                    <span>
                                        <span id="co2-ki-current" class="pid-param-value">-</span>
                                        <span id="co2-ki-change" class="pid-param-change"></span>
                                    </span>
                                </div>
                                <div class="pid-param">
                                    <span class="pid-param-label">Kd:</span>
                                    <span>
                                        <span id="co2-kd-current" class="pid-param-value">-</span>
                                        <span id="co2-kd-change" class="pid-param-change"></span>
                                    </span>
                                </div>
                                <div class="pid-param">
                                    <span class="pid-param-label">√ò Fehler:</span>
                                    <span id="co2-avg-error" class="pid-param-value">-</span>
                                </div>
                            </div>
                        </div>
                        <p class="info-text" style="margin-top: 15px; margin-bottom: 0;">
                            ‚ÑπÔ∏è Bei aktivierter adaptiver Regelung passen sich diese Werte automatisch an.
                            Die √Ñnderung gegen√ºber den Basis-Werten wird angezeigt.
                        </p>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="adaptive_pid" name="adaptive_pid" style="width: auto;">
                            <span>Adaptive PID-Regelung aktivieren</span>
                        </label>
                        <p class="info-text">
                            ‚ú® Empfohlen: Die adaptive Regelung passt die PID-Parameter automatisch an die Systemdynamik an.
                            Bei Aktivierung lernt das System die optimalen Parameter selbst und du musst nichts manuell anpassen.
                        </p>
                    </div>
                    
                    <div id="manual-pid-settings" style="display: none;">
                        <h3 style="color: #718096; font-size: 1rem; margin-top: 20px;">Manuelle PID-Parameter</h3>
                        <p class="info-text" style="color: #f39c12;">
                            ‚ö†Ô∏è Nur f√ºr Experten: Manuelle Anpassung erfordert Kenntnisse der PID-Regelung.
                        </p>
                        
                        <!-- Temperatur PID -->
                        <div style="margin-top: 15px;">
                            <h4 style="color: #a0aec0; font-size: 0.9rem;">Temperatur-Regler</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="pid_temp_kp">Kp (Proportional)</label>
                                    <input type="number" id="pid_temp_kp" name="pid_temp_kp" step="0.1" min="0" max="10">
                                </div>
                                <div class="form-group">
                                    <label for="pid_temp_ki">Ki (Integral)</label>
                                    <input type="number" id="pid_temp_ki" name="pid_temp_ki" step="0.1" min="0" max="5">
                                </div>
                                <div class="form-group">
                                    <label for="pid_temp_kd">Kd (Differential)</label>
                                    <input type="number" id="pid_temp_kd" name="pid_temp_kd" step="0.1" min="0" max="5">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Luftfeuchtigkeit PID -->
                        <div style="margin-top: 15px;">
                            <h4 style="color: #a0aec0; font-size: 0.9rem;">Luftfeuchtigkeit-Regler</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="pid_humidity_kp">Kp (Proportional)</label>
                                    <input type="number" id="pid_humidity_kp" name="pid_humidity_kp" step="0.1" min="0" max="10">
                                </div>
                                <div class="form-group">
                                    <label for="pid_humidity_ki">Ki (Integral)</label>
                                    <input type="number" id="pid_humidity_ki" name="pid_humidity_ki" step="0.1" min="0" max="5">
                                </div>
                                <div class="form-group">
                                    <label for="pid_humidity_kd">Kd (Differential)</label>
                                    <input type="number" id="pid_humidity_kd" name="pid_humidity_kd" step="0.1" min="0" max="5">
                                </div>
                            </div>
                        </div>
                        
                        <!-- CO2 PID -->
                        <div style="margin-top: 15px;">
                            <h4 style="color: #a0aec0; font-size: 0.9rem;">CO‚ÇÇ-Regler</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="pid_co2_kp">Kp (Proportional)</label>
                                    <input type="number" id="pid_co2_kp" name="pid_co2_kp" step="0.1" min="0" max="10">
                                </div>
                                <div class="form-group">
                                    <label for="pid_co2_ki">Ki (Integral)</label>
                                    <input type="number" id="pid_co2_ki" name="pid_co2_ki" step="0.1" min="0" max="5">
                                </div>
                                <div class="form-group">
                                    <label for="pid_co2_kd">Kd (Differential)</label>
                                    <input type="number" id="pid_co2_kd" name="pid_co2_kd" step="0.1" min="0" max="5">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Buttons -->
                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="loadSettings()">
                        Zur√ºcksetzen
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Einstellungen speichern
                    </button>
                </div>
            </form>
            
            <!-- System Terminal -->
            <div class="settings-section">
                <h2>üíª System-Terminal</h2>
                <div class="terminal-container">
                    <div class="terminal-header">
                        <span class="terminal-title">MGB System Log</span>
                        <div class="terminal-buttons">
                            <div class="terminal-btn close" onclick="clearTerminal()" title="Clear"></div>
                            <div class="terminal-btn minimize" onclick="minimizeTerminal()" title="Minimize"></div>
                            <div class="terminal-btn maximize" onclick="toggleFullscreen()" title="Fullscreen"></div>
                        </div>
                    </div>
                    <div id="terminal-output" class="terminal-output">
                        <div class="terminal-line info">‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó</div>
                        <div class="terminal-line info">‚ïë  MGB - Mushroom Grow Box System Terminal v2.0            ‚ïë</div>
                        <div class="terminal-line info">‚ïë  Bereit f√ºr Befehle und Echtzeit-Logging                 ‚ïë</div>
                        <div class="terminal-line info">‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù</div>
                        <div class="terminal-line success">[SYSTEM] Terminal initialisiert</div>
                        <div class="terminal-line info">[INFO] Verwende 'help' f√ºr verf√ºgbare Befehle</div>
                    </div>
                    <div class="terminal-input-container">
                        <span class="terminal-prompt">$ </span>
                        <input type="text" id="terminal-input" class="terminal-input" placeholder="Befehl eingeben..." autocomplete="off">
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Toggle manuelle PID-Einstellungen
        document.getElementById('adaptive_pid').addEventListener('change', function(e) {
            const manualSettings = document.getElementById('manual-pid-settings');
            manualSettings.style.display = e.target.checked ? 'none' : 'block';
        });
        
        // PID-Status alle 5 Sekunden aktualisieren
        async function updatePIDStatus() {
            try {
                const response = await fetch('/api/pid/status');
                const status = await response.json();
                
                // Temperatur
                updatePIDDisplay('temp', status.temperature);
                // Luftfeuchtigkeit
                updatePIDDisplay('humidity', status.humidity);
                // CO2
                updatePIDDisplay('co2', status.co2);
                
            } catch (error) {
                console.error('Fehler beim Laden des PID-Status:', error);
            }
        }
        
        function updatePIDDisplay(sensor, data) {
            // Kp
            document.getElementById(`${sensor}-kp-current`).textContent = data.kp_current.toFixed(2);
            updateChangeIndicator(`${sensor}-kp-change`, data.kp_current, data.kp_base);
            
            // Ki
            document.getElementById(`${sensor}-ki-current`).textContent = data.ki_current.toFixed(2);
            updateChangeIndicator(`${sensor}-ki-change`, data.ki_current, data.ki_base);
            
            // Kd
            document.getElementById(`${sensor}-kd-current`).textContent = data.kd_current.toFixed(2);
            updateChangeIndicator(`${sensor}-kd-change`, data.kd_current, data.kd_base);
            
            // Durchschnittsfehler
            document.getElementById(`${sensor}-avg-error`).textContent = data.avg_error.toFixed(2);
        }
        
        function updateChangeIndicator(elementId, current, base) {
            const element = document.getElementById(elementId);
            const change = ((current - base) / base * 100).toFixed(1);
            
            if (Math.abs(change) < 0.5) {
                element.textContent = '';
                element.className = 'pid-param-change';
            } else if (change > 0) {
                element.textContent = `+${change}%`;
                element.className = 'pid-param-change positive';
            } else {
                element.textContent = `${change}%`;
                element.className = 'pid-param-change negative';
            }
        }
        
        // PID-Status initial laden und dann alle 5 Sekunden
        updatePIDStatus();
        setInterval(updatePIDStatus, 5000);
        
        // Terminal-Funktionalit√§t
        const terminalOutput = document.getElementById('terminal-output');
        const terminalInput = document.getElementById('terminal-input');
        let commandHistory = [];
        let historyIndex = -1;
        
        function addTerminalLine(text, type = 'info') {
            const line = document.createElement('div');
            line.className = `terminal-line ${type}`;
            const timestamp = new Date().toLocaleTimeString('de-DE');
            line.textContent = `[${timestamp}] ${text}`;
            terminalOutput.appendChild(line);
            terminalOutput.scrollTop = terminalOutput.scrollHeight;
        }
        
        function clearTerminal() {
            terminalOutput.innerHTML = '';
            addTerminalLine('Terminal gel√∂scht', 'info');
        }
        
        function minimizeTerminal() {
            const terminal = document.querySelector('.terminal-container');
            if (terminal.style.height === '80px') {
                terminal.style.height = 'auto';
                addTerminalLine('Terminal wiederhergestellt', 'info');
            } else {
                terminal.style.height = '80px';
                addTerminalLine('Terminal minimiert', 'info');
            }
        }
        
        function toggleFullscreen() {
            const terminal = document.querySelector('.terminal-container');
            if (terminal.style.position === 'fixed') {
                terminal.style.position = 'relative';
                terminal.style.top = 'auto';
                terminal.style.left = 'auto';
                terminal.style.width = 'auto';
                terminal.style.height = 'auto';
                terminal.style.zIndex = 'auto';
                addTerminalLine('Fullscreen beendet', 'info');
            } else {
                terminal.style.position = 'fixed';
                terminal.style.top = '10px';
                terminal.style.left = '10px';
                terminal.style.width = 'calc(100% - 20px)';
                terminal.style.height = 'calc(100% - 20px)';
                terminal.style.zIndex = '9999';
                addTerminalLine('Fullscreen aktiviert', 'info');
            }
        }
        
        // Terminal Befehle verarbeiten
        terminalInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const command = this.value.trim();
                if (command) {
                    commandHistory.unshift(command);
                    historyIndex = -1;
                    
                    addTerminalLine(`$ ${command}`, 'info');
                    processCommand(command);
                    this.value = '';
                }
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (historyIndex < commandHistory.length - 1) {
                    historyIndex++;
                    this.value = commandHistory[historyIndex];
                }
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (historyIndex > 0) {
                    historyIndex--;
                    this.value = commandHistory[historyIndex];
                } else {
                    historyIndex = -1;
                    this.value = '';
                }
            }
        });
        
        async function processCommand(cmd) {
            const parts = cmd.toLowerCase().split(' ');
            const command = parts[0];
            
            switch(command) {
                case 'help':
                    addTerminalLine('Verf√ºgbare Befehle:', 'success');
                    addTerminalLine('  help          - Zeigt diese Hilfe', 'info');
                    addTerminalLine('  status        - Zeigt System-Status', 'info');
                    addTerminalLine('  pid           - Zeigt PID-Parameter', 'info');
                    addTerminalLine('  sensors       - Zeigt Sensor-Werte', 'info');
                    addTerminalLine('  actuators     - Zeigt Aktor-Status', 'info');
                    addTerminalLine('  clear         - L√∂scht Terminal', 'info');
                    addTerminalLine('  version       - Zeigt Version', 'info');
                    break;
                    
                case 'status':
                    addTerminalLine('System-Status wird abgerufen...', 'info');
                    try {
                        const response = await fetch('/api/status');
                        const data = await response.json();
                        addTerminalLine(`Mode: ${data.mode}`, 'success');
                        addTerminalLine(`Sensoren: ${Object.keys(data.sensors).length} aktiv`, 'success');
                        addTerminalLine(`Aktoren: ${Object.keys(data.actuators).length} verf√ºgbar`, 'success');
                    } catch (error) {
                        addTerminalLine('Fehler beim Abrufen des Status', 'error');
                    }
                    break;
                    
                case 'pid':
                    addTerminalLine('PID-Parameter werden abgerufen...', 'info');
                    try {
                        const response = await fetch('/api/pid/status');
                        const data = await response.json();
                        addTerminalLine('--- Temperatur PID ---', 'success');
                        addTerminalLine(`  Kp: ${data.temperature.kp_current.toFixed(2)} (Basis: ${data.temperature.kp_base})`, 'info');
                        addTerminalLine(`  Ki: ${data.temperature.ki_current.toFixed(2)} (Basis: ${data.temperature.ki_base})`, 'info');
                        addTerminalLine(`  Kd: ${data.temperature.kd_current.toFixed(2)} (Basis: ${data.temperature.kd_base})`, 'info');
                        addTerminalLine('--- Luftfeuchtigkeit PID ---', 'success');
                        addTerminalLine(`  Kp: ${data.humidity.kp_current.toFixed(2)} (Basis: ${data.humidity.kp_base})`, 'info');
                        addTerminalLine(`  Ki: ${data.humidity.ki_current.toFixed(2)} (Basis: ${data.humidity.ki_base})`, 'info');
                        addTerminalLine(`  Kd: ${data.humidity.kd_current.toFixed(2)} (Basis: ${data.humidity.kd_base})`, 'info');
                    } catch (error) {
                        addTerminalLine('Fehler beim Abrufen der PID-Parameter', 'error');
                    }
                    break;
                    
                case 'sensors':
                    addTerminalLine('Sensor-Werte werden abgerufen...', 'info');
                    try {
                        const response = await fetch('/api/status');
                        const data = await response.json();
                        addTerminalLine(`üå°Ô∏è  Temperatur: ${data.sensors.temperature.value}¬∞C (Ziel: ${data.sensors.temperature.target}¬∞C)`, 'success');
                        addTerminalLine(`üíß Luftfeuchtigkeit: ${data.sensors.humidity.value}% (Ziel: ${data.sensors.humidity.target}%)`, 'success');
                        addTerminalLine(`üå¨Ô∏è  CO‚ÇÇ: ${data.sensors.co2.value} ppm (Ziel: ${data.sensors.co2.target} ppm)`, 'success');
                    } catch (error) {
                        addTerminalLine('Fehler beim Abrufen der Sensor-Werte', 'error');
                    }
                    break;
                    
                case 'actuators':
                    addTerminalLine('Aktor-Status wird abgerufen...', 'info');
                    try {
                        const response = await fetch('/api/status');
                        const data = await response.json();
                        for (const [name, status] of Object.entries(data.actuators)) {
                            const state = status.active ? 'üü¢ AKTIV' : '‚ö´ AUS';
                            addTerminalLine(`${name}: ${state}`, status.active ? 'success' : 'info');
                        }
                    } catch (error) {
                        addTerminalLine('Fehler beim Abrufen des Aktor-Status', 'error');
                    }
                    break;
                    
                case 'clear':
                    clearTerminal();
                    break;
                    
                case 'version':
                    addTerminalLine('MGB - Mushroom Grow Box v2.0', 'success');
                    addTerminalLine('Adaptive PID Control System', 'info');
                    addTerminalLine('¬© 2025 - Python/Flask WebUI', 'info');
                    break;
                    
                default:
                    addTerminalLine(`Unbekannter Befehl: ${command}`, 'error');
                    addTerminalLine('Verwende "help" f√ºr verf√ºgbare Befehle', 'warning');
            }
        }
        
        // Einstellungen beim Laden der Seite abrufen
        window.addEventListener('DOMContentLoaded', loadSettings);
        
        async function loadSettings() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                // Temperatur
                document.getElementById('temp_target').value = config.sensors.temperature.target_value;
                document.getElementById('temp_tolerance').value = config.sensors.temperature.tolerance;
                
                // Luftfeuchtigkeit
                document.getElementById('humidity_target').value = config.sensors.humidity.target_value;
                document.getElementById('humidity_tolerance').value = config.sensors.humidity.tolerance;
                
                // CO2
                document.getElementById('co2_target').value = config.sensors.co2.target_value;
                document.getElementById('co2_tolerance').value = config.sensors.co2.tolerance;
                
                // Tag/Nacht-Rhythmus
                document.getElementById('day_start').value = config.schedule.day_start;
                document.getElementById('night_start').value = config.schedule.night_start;
                document.getElementById('day_temperature').value = config.schedule.day_temperature;
                document.getElementById('night_temperature').value = config.schedule.night_temperature;
                document.getElementById('day_humidity').value = config.schedule.day_humidity;
                document.getElementById('night_humidity').value = config.schedule.night_humidity;
                
                // PID-Einstellungen
                const adaptivePid = config.pid?.adaptive !== false; // Default true
                document.getElementById('adaptive_pid').checked = adaptivePid;
                document.getElementById('manual-pid-settings').style.display = adaptivePid ? 'none' : 'block';
                
                if (config.pid) {
                    // Temperatur PID
                    if (config.pid.temperature) {
                        document.getElementById('pid_temp_kp').value = config.pid.temperature.kp;
                        document.getElementById('pid_temp_ki').value = config.pid.temperature.ki;
                        document.getElementById('pid_temp_kd').value = config.pid.temperature.kd;
                    }
                    // Luftfeuchtigkeit PID
                    if (config.pid.humidity) {
                        document.getElementById('pid_humidity_kp').value = config.pid.humidity.kp;
                        document.getElementById('pid_humidity_ki').value = config.pid.humidity.ki;
                        document.getElementById('pid_humidity_kd').value = config.pid.humidity.kd;
                    }
                    // CO2 PID
                    if (config.pid.co2) {
                        document.getElementById('pid_co2_kp').value = config.pid.co2.kp;
                        document.getElementById('pid_co2_ki').value = config.pid.co2.ki;
                        document.getElementById('pid_co2_kd').value = config.pid.co2.kd;
                    }
                }
                
            } catch (error) {
                console.error('Fehler beim Laden der Einstellungen:', error);
                showMessage('Fehler beim Laden der Einstellungen', 'error');
            }
        }
        
        // Formular absenden
        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const settings = {
                sensors: {
                    temperature: {
                        target_value: parseFloat(formData.get('temp_target')),
                        tolerance: parseFloat(formData.get('temp_tolerance'))
                    },
                    humidity: {
                        target_value: parseFloat(formData.get('humidity_target')),
                        tolerance: parseFloat(formData.get('humidity_tolerance'))
                    },
                    co2: {
                        target_value: parseInt(formData.get('co2_target')),
                        tolerance: parseInt(formData.get('co2_tolerance'))
                    }
                },
                schedule: {
                    day_start: formData.get('day_start'),
                    night_start: formData.get('night_start'),
                    day_temperature: parseFloat(formData.get('day_temperature')),
                    night_temperature: parseFloat(formData.get('night_temperature')),
                    day_humidity: parseFloat(formData.get('day_humidity')),
                    night_humidity: parseFloat(formData.get('night_humidity'))
                },
                pid: {
                    adaptive: document.getElementById('adaptive_pid').checked
                }
            };
            
            // Nur manuelle PID-Parameter hinzuf√ºgen, wenn adaptive Regelung deaktiviert ist
            if (!settings.pid.adaptive) {
                settings.pid.temperature = {
                    kp: parseFloat(formData.get('pid_temp_kp')),
                    ki: parseFloat(formData.get('pid_temp_ki')),
                    kd: parseFloat(formData.get('pid_temp_kd'))
                };
                settings.pid.humidity = {
                    kp: parseFloat(formData.get('pid_humidity_kp')),
                    ki: parseFloat(formData.get('pid_humidity_ki')),
                    kd: parseFloat(formData.get('pid_humidity_kd'))
                };
                settings.pid.co2 = {
                    kp: parseFloat(formData.get('pid_co2_kp')),
                    ki: parseFloat(formData.get('pid_co2_ki')),
                    kd: parseFloat(formData.get('pid_co2_kd'))
                };
            }
                schedule: {
                    day_start: formData.get('day_start'),
                    night_start: formData.get('night_start'),
                    day_temperature: parseFloat(formData.get('day_temperature')),
                    night_temperature: parseFloat(formData.get('night_temperature')),
                    day_humidity: parseFloat(formData.get('day_humidity')),
                    night_humidity: parseFloat(formData.get('night_humidity'))
                }
            };
            
            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('‚úì Einstellungen erfolgreich gespeichert!', 'success');
                } else {
                    showMessage('‚úó Fehler: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Fehler beim Speichern:', error);
                showMessage('‚úó Fehler beim Speichern der Einstellungen', 'error');
            }
        });
        
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
